name: Build and Deploy

on:
  push:
    branches:
      - main        # Production
      - staging     # Staging environment
      - develop     # Development environment
  pull_request:
    branches:
      - main
      - staging
      - develop

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Build Backend
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Check Python syntax
      working-directory: ./backend
      run: |
        python -m py_compile app/**/*.py || echo "Syntax check completed"
    
    - name: Run backend tests
      working-directory: ./backend
      run: |
        python -m pytest tests/ -v --tb=short --maxfail=5
      continue-on-error: false
    
    - name: Generate test report
      if: always()
      uses: dorny/test-reporter@v1
      with:
        name: Backend Tests
        path: backend/test-results.xml
        reporter: java-junit
        fail-on-error: false
    
    - name: Upload backend artifacts
      uses: actions/upload-artifact@v3
      with:
        name: backend-build
        path: backend/
        retention-days: 7

  # Job 2: Build Frontend
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Type check
      working-directory: ./frontend
      run: npm run type-check || npx tsc --noEmit
      continue-on-error: true
    
    - name: Build frontend
      working-directory: ./frontend
      env:
        NODE_ENV: production
        VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:8000' }}
      run: npm run build
    
    - name: Check build output
      working-directory: ./frontend
      run: |
        if [ ! -d "dist" ]; then
          echo "‚ùå Build failed: dist directory not found"
          exit 1
        fi
        echo "‚úÖ Build successful: dist directory created"
        ls -la dist/
    
    - name: Upload frontend build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 7

  # Job 3: Run E2E Tests
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        pip install -r requirements.txt
    
    - name: Run E2E tests
      working-directory: ./backend
      run: |
        python -m pytest tests/test_e2e.py -v --tb=short
      continue-on-error: true

  # Job 4: Security Scan
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  # Job 5: Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, e2e-tests]
    if: github.ref == 'refs/heads/staging' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.cv-sorting-system.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download frontend artifacts
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist
    
    - name: Deploy to Staging
      run: |
        echo "üöÄ Deploying to staging environment..."
        echo "‚úÖ Deployment would happen here (configure with your hosting provider)"
        # Example: Deploy to Vercel, Netlify, or your server
        # npx vercel --token=${{ secrets.VERCEL_TOKEN }} --prod
    
    - name: Notify deployment status
      if: always()
      run: |
        echo "üìß Deployment notification sent"

  # Job 6: Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend, e2e-tests, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
      url: https://cv-sorting-system.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download frontend artifacts
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist
    
    - name: Deploy to Production
      run: |
        echo "üöÄ Deploying to production environment..."
        echo "‚úÖ Deployment would happen here (configure with your hosting provider)"
        # Example: Deploy to production server
        # Add your deployment commands here
    
    - name: Create deployment tag
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        git tag -a "v$(date +'%Y.%m.%d-%H%M')" -m "Production deployment $(date)"
        git push origin --tags || echo "Tag already exists"
    
    - name: Notify production deployment
      if: always()
      run: |
        echo "üìß Production deployment notification sent"

  # Job 7: Notify Build Status
  notify:
    name: Notify Build Status
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always()
    
    steps:
    - name: Check build status
      run: |
        echo "Build Status Summary:"
        echo "Backend Build: ${{ needs.build-backend.result }}"
        echo "Frontend Build: ${{ needs.build-frontend.result }}"
        
        if [ "${{ needs.build-backend.result }}" == "success" ] && [ "${{ needs.build-frontend.result }}" == "success" ]; then
          echo "‚úÖ All builds successful!"
          exit 0
        else
          echo "‚ùå Some builds failed"
          exit 1
        fi
